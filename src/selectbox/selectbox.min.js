"use strict";angular.module("selectbox",[]).filter("contains",[function(){return function(e,t){return e&&t?-1!==e.indexOf(t):-1}}]).filter("get_selected",[function(){return function(e){return angular.isArray(e)?e.join():e}}]).service("SelectBox",[function(){return{counter:0,init:function(){this.counter+=1}}}]).controller("SelectBoxCtrl",["$scope","$document","$element","SelectBox","$analytics",function(e,t,i,n,l){n.init(),e.view={},e.view.show=!1,e.view.tabindex=n.counter,e.view.instanceId="inst-"+Date.now(),e.analytics={};var s=function(t){var i=angular.element(t.target),n=i.attr("id"),l=e.multi&&"undefined"==typeof n&&i.hasClass("mad-selectbox-item");return e.view.instanceId===n||l?!1:(e.view.show=!1,e.$apply(),void o())},c=function(t){if(-1!==[13,32].indexOf(t.keyCode)&&"undefined"!=typeof e.view.focus)return e.selectItem(e.view.focus),e.multi||(o(),e.view.show=!1),e.$apply(),!1;if(-1===[38,40].indexOf(t.keyCode))return!1;var n=0,l=e.list.length-1;e.view.focus="undefined"==typeof e.view.focus?-1:e.view.focus,40===t.keyCode&&(e.view.focus===l?e.view.focus=n:e.view.focus+=1),38===t.keyCode&&(e.view.focus<=n?e.view.focus=l:e.view.focus-=1),e.$apply();var s=i[0].querySelector(".mad-selectbox-dropdown"),c=s.querySelector(".focus"),a=s.offsetHeight,d=c.offsetHeight*(e.view.focus+1);d>=a?s.scrollTop=d:d<=s.scrollTop&&(s.scrollTop=0)},a=function(){"undefined"!=typeof e.list&&(e.view.selected=e.multi?e.index:e.list[e.index])};e.toggleList=function(){e.view.show=!e.view.show,e.view.show?(t.bind("click",s),i.on("keydown",c)):o()},e.selectItem=function(t){if(e.multi){var i=e.list[t];"undefined"!=typeof e.key&&(i=e.list[t][e.key]);var n=-1;if("undefined"!=typeof e.view.selected?n=e.view.selected.indexOf(i):e.view.selected=[],-1!==n){if(e.view.selected.length<=parseInt(e.min,10))return!1;e.view.selected.splice(n,1)}else e.view.selected.push(i);e.index=e.view.selected,e.value=e.view.selected}else e.view.selected=e.key&&e.list[t][e.key]?e.list[t][e.key]:e.list[t],e.index=t,e.value=e.view.selected;e.sendAnalytics()},a(),e.$watch("list.length",function(e,t){e!==t&&a()}),e.$watch("index",function(t,i){t!==i&&(a(),e.handler())}),e.setSelected=function(t){for(var i=0;i<e.list.length;i++)e.key&&e.list[i][e.key]==t?e.selectItem(i):e.list[i]==t&&e.selectItem(i)},e.$watch("selected",function(){if("undefined"!=typeof e.selected)if(e.multi)for(var t=JSON.parse(e.selected),i=0;i<t.length;i++)e.setSelected(t[i]);else e.setSelected(e.selected)}),e.sendAnalytics=function(){e.analyticsevent&&l.eventTrack(e.analyticsevent,{category:e.analyticscategory,label:e.analyticslabel})};var o=function(){e.view.focus=-1,t.unbind("click",s),i.off("keydown",c)};e.$on("$destroy",function(){o()})}]).directive("selectbox",[function(){return{restrict:"E",replace:!0,scope:{list:"=",index:"@",value:"=ngModel",multi:"@",title:"@",min:"@",handler:"&",key:"@",display:"@",name:"@",selected:"@",analyticson:"@",analyticsevent:"@",analyticscategory:"@",analyticslabel:"@",id:"@",required:"@"},controller:"SelectBoxCtrl",template:'<div tabindex="{{ view.tabindex }}" class="mad-selectbox" ng-class="{\'mad-selectbox-multi\': multi}"><a href id="{{ view.instanceId }}"class="mad-selectbox-toggle"ng-click="toggleList()"ng-class="{active: view.show}">{{ (view.selected[display] || view.selected.name || (view.selected | get_selected) || title || \'Select\') }}</a><input class="hide" type="text" name="{{ name }}" value="{{ value }}" ng-model="value" ng-required="required" analytics-on="{{ analyticson }}"  analytics-event="{{ analyticsevent }}" analytics-category="{{ analyticscategory }}" analytics-label="{{ analyticslabel }}" id="{{ id }}" /><ul class="mad-selectbox-dropdown" ng-show="view.show"><li ng-repeat="item in list track by $index"ng-class="{active: multi ? (view.selected | contains:item.id) : ($index === index), focus: ($index === view.focus)}"><a href class="mad-selectbox-item" ng-click="selectItem($index)">{{ item[display] || item.name || item  }}</a></li><li class="mad-empty" ng-if="list.length === 0">the list is empty</li></ul></div>'}}]);